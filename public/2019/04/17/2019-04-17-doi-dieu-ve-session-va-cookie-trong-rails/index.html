<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Đặt vấn đềsession[:user_id] = @user.id, dòng code này thật quen thuộc? khi làm chức năng đăng nhập trong những ngày nhập môn, hẳn ai cũng đã từng làm qua hoặc làm gần giống như vậy, ta được dạy rằng,">
<meta name="keywords" content="rails,secure">
<meta property="og:type" content="article">
<meta property="og:title" content="Session Vs Cookies Trong Rails">
<meta property="og:url" content="https:&#x2F;&#x2F;hdchinh.github.io&#x2F;2019&#x2F;04&#x2F;17&#x2F;2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails&#x2F;index.html">
<meta property="og:site_name" content="Chinh&#39;s Notes">
<meta property="og:description" content="Đặt vấn đềsession[:user_id] = @user.id, dòng code này thật quen thuộc? khi làm chức năng đăng nhập trong những ngày nhập môn, hẳn ai cũng đã từng làm qua hoặc làm gần giống như vậy, ta được dạy rằng,">
<meta property="og:locale" content="en">
<meta property="og:updated_time" content="2019-11-13T04:04:32.387Z">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Session Vs Cookies Trong Rails</title>
    <!-- styles -->
    <link rel="stylesheet" href="/css/style.css">
    <!-- persian styles -->
    
      <link rel="stylesheet" href="/css/rtl.css">
    
    <!-- rss -->
    
    
</head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects/">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/04/17/2019-05-16-autoloading-va-reloading-constants-trong-rails/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/04/11/2019-04-11-su-dung-carrierwave-voi-s3/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&text=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&is_video=false&description=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Session Vs Cookies Trong Rails&body=Check out this article: https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&name=Session Vs Cookies Trong Rails&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Dat-van-de"><span class="toc-number">1.</span> <span class="toc-text">Đặt vấn đề</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Luan-ban"><span class="toc-number">2.</span> <span class="toc-text">Luận bàn</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Flow-hoat-dong"><span class="toc-number">3.</span> <span class="toc-text">1. Flow hoạt động</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Mot-vai-loai-cookies-quan-trong-trong-rails"><span class="toc-number">4.</span> <span class="toc-text">2. Một vài loại cookies quan trọng trong rails</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Giai-ma-cookies-va-tim-hieu-ve-session-trong-rails"><span class="toc-number">5.</span> <span class="toc-text">3. Giải mã cookies và tìm hiểu về session trong rails</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ket-luan"><span class="toc-number">6.</span> <span class="toc-text">Kết luận</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Session Vs Cookies Trong Rails
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Chinh's Notes</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2019-04-16T17:00:00.000Z" itemprop="datePublished">2019-04-17</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/rails-notes/">rails notes</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/rails/" rel="tag">rails</a>, <a class="tag-link" href="/tags/secure/" rel="tag">secure</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Dat-van-de"><a href="#Dat-van-de" class="headerlink" title="Đặt vấn đề"></a>Đặt vấn đề</h1><p><code>session[:user_id] = @user.id</code>, dòng code này thật quen thuộc? khi làm chức năng đăng nhập trong những ngày nhập môn, hẳn ai cũng đã từng làm qua hoặc làm gần giống như vậy, ta được dạy rằng, <code>http</code> là 1 giao thức không có trạng thái nên request thứ <code>N + 1</code> sẽ chẳng thể biết được request thứ <code>N</code> đã làm gì, vậy nếu ở lần request thứ <code>N</code> chúng ta đã thực hiện hành vi đăng nhập, và <code>http</code> thì không có lưu vết lại điều đó, hệ quả là ở lần request tiếp theo, website hiểu như bạn chưa đăng nhập, rất đáng buồn.</p>
<p>Cũng theo những gì được dạy, <code>session/cookies</code> được tạo ra với mục đích làm cho http request có “trạng thái”. Vì sao lại để từ trạng thái trong nháy kép, vì thực sự là <code>http</code> không bao giờ có trạng thái cả, mà <code>session/cookies</code> với khả năng lưu vết của mình có thể giúp website nắm được một số <strong>thông tin</strong> từ client đã request trước đó và làm chúng giống như <code>http</code> đã có trạng thái.</p>
<p>Quá mơ hồ? đúng vậy, khi được dạy điều này tôi cũng thấy thật mơ hồ, wth is trạng thái? phi trạng thái? lưu vết?… Hy vọng bài viết này sẽ giúp người đọc có 1 cái nhìn dễ hiểu hơn về 2 đối tượng này trong ruby on rails.</p>
<h1 id="Luan-ban"><a href="#Luan-ban" class="headerlink" title="Luận bàn"></a>Luận bàn</h1><h1 id="1-Flow-hoat-dong"><a href="#1-Flow-hoat-dong" class="headerlink" title="1. Flow hoạt động"></a>1. Flow hoạt động</h1><p>Một cách ngắn gọn cookies sẽ được vận hành như sau:</p>
<p><strong>Step 1</strong>: Lần đầu bạn request đến web ABC.com, nhẹ nhàng tựa mây bay, bạn không mang theo thông tin gì của ABC.com cả</p>
<p><strong>Step 2</strong>: ABC.com nhận request của bạn, nó nhận ra bạn không mang theo cookies của website, nên nó trong response trả về nó set một hoặc một vài cookies mặc định cho bạn.</p>
<p><strong>Step 3</strong>: Bạn nhận được response của ABC.com, rồi bạn tiếp tục request lên ABC.com lần thứ 2, lần này đi theo request của bạn là toàn bộ số cookies đã được khởi tạo ở bước 2.</p>
<p><strong>Step 4</strong>: ABC.com lại nhận được request của bạn, và lần này nó đã thấy bạn mang cookies của ABC.com nên nó sẽ đọc nội dung trong cookies đó (nếu cần).</p>
<h1 id="2-Mot-vai-loai-cookies-quan-trong-trong-rails"><a href="#2-Mot-vai-loai-cookies-quan-trong-trong-rails" class="headerlink" title="2. Một vài loại cookies quan trọng trong rails"></a>2. Một vài loại cookies quan trọng trong rails</h1><ol>
<li><p><code>Normal cookies</code>: Một dạng cookie mà dữ liệu được lưu trữ dưới dạng text.</p>
</li>
<li><p><code>Signed cookies</code>: Một dạng cookie mà dữ liệu lưu trữ sẽ được “ký” bởi 1 <code>digest</code>, và <code>digest</code> này được tạo ra bởi <code>secret_key_base</code> trong app của bạn, sau đó nó sẽ được chuyển sang dạng <code>base64</code> code. Điều này có nghĩa là nếu ai đó có được <code>signed cookies</code> của bạn, thì họ hoàn toàn có thể đọc được nội dung bên trong (decode base64 là có thể đọc được). Tuy nhiên nếu họ sửa lại nội dung của cookies đó và gửi lên server thì lúc này, cookies này trở thành 1 cookies không hợp lệ, vì sao? Vì như đã trình bày, nó được ký bởi 1 digest sinh ra qua <code>secret_key_base</code>, vậy nên cookies loại này nếu bị sửa đổi nội dung ở client thì khi kiểm tra tính toàn vẹn trên server thông qua digest sẽ không còn đúng nữa. Và nó trở thành 1 cookies không hợp lệ.</p>
</li>
<li><p><code>Encrypted cookies</code>: Một dạng cookies mà dữ liệu được mã hóa qua một quá trình mã hóa với 1 khóa quan trọng là <code>secret_key_base</code>, một cách đơn giản nhất để hiểu là không có <code>secret_key_base</code> thì ta không thể nào <strong>đọc</strong> hay sửa đổi dữ liệu của cookies này được.</p>
</li>
</ol>
<p>Ví dụ:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cookies.signed[<span class="symbol">:signed</span>] = <span class="string">"Duy Chinh"</span></span><br><span class="line">cookies.encrypted[<span class="symbol">:encrypted</span>] = <span class="string">"Duy Chinh"</span></span><br><span class="line">cookies[<span class="symbol">:normal</span>] = <span class="string">"Duy Chinh"</span></span><br></pre></td></tr></table></figure>
<p>Tôi đã tạo 3 cookies ứng với 3 dạng cookies nêu ở trên, giá trị của chúng đều giống nhau (đều được gán bằng “Duy Chinh”).</p>
<p>Hãy xem giá trị ở client nhận được:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">normal = <span class="string">"Duy+Chinh"</span></span><br><span class="line">signed = <span class="string">"IkR1eSBDaGluaCI%3D--a3af2bfd61abcd20cc3b8ac714968d0aaf578fe5"</span></span><br><span class="line">encrypted = <span class="string">"%2BVulShtBgFR2I18%3D--zQP8FmCAW4%2FZUwar--CQ%2FH6HFHSVlox5H8QC4CTg%3D%3D"</span></span><br></pre></td></tr></table></figure>

<p>Nhận xét:</p>
<ol>
<li><p>Kiểu cookies thông thường, dữ liệu lưu dạng text nên ở client ta dễ dàng đọc được nội dung cũng như sửa đổi dữ liệu của chúng.</p>
</li>
<li><p>Nhìn signed cookies và encrypted cookies đều không thân thiện với người dùng cuối, vì chúng gồm những ký tự không có ngữ nghĩa với end user.</p>
</li>
<li><p>Nếu decode <code>base64</code> ta thu được giá trị của signed cookies ở trên là: <code>&quot;Duy Chinh&quot;7횿f߷횭Ƕч7oƜ뇴i繯Ǟ䀀</code>, dù một số ký tự phía sau không thể hiểu được, tuy nhiên không quan trọng vì nội dung cookies vẫn được giải mã (đúng với tính chất, có thể đọc nhưng không thể sửa đổi).</p>
</li>
<li><p>Việc decode encrypted cookies là vô vọng khi không có <code>secret_key_base</code>.</p>
</li>
</ol>
<p><strong>NOTE:</strong></p>
<p>Việc sử dụng loại cookies nào sẽ đúng trong những trường hợp cụ thể, với những dữ liệu vô hại và không hề quan trọng thì sử dụng cookies thông thường và lưu mọi thứ dưới dạng text là khả dĩ hơn cả. Bỏ qua các bước mã hóa giúp nó hoạt động với performance tốt hơn hẳn 2 dạng cookies còn lại.<br>Ngược lại, encrypted cookies là dạng cookies tốn công sức để xử lý nhất, vì vậy hãy chỉ sử dụng nó cho những thông tin thực sự quan trọng và không thể để lộ (những thông tin bớt quan trọng hơn và chỉ cần đảm bảo tính toàn vẹn của dữ liệu chứ không cần bảo mật thông tin thì hãy dùng signed cookies).</p>
<h1 id="3-Giai-ma-cookies-va-tim-hieu-ve-session-trong-rails"><a href="#3-Giai-ma-cookies-va-tim-hieu-ve-session-trong-rails" class="headerlink" title="3. Giải mã cookies và tìm hiểu về session trong rails"></a>3. Giải mã cookies và tìm hiểu về session trong rails</h1><p>Sau khá nhiều công sức tìm kiếm, tôi đã tìm ra cách để giải mã cookies trong rails 5.2, nội dung đơn giản như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'cgi'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'active_support'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verify_and_decrypt_session_cookie</span><span class="params">(cookie, secret_key_base)</span></span></span><br><span class="line">  cookie                  = CGI::unescape(cookie)</span><br><span class="line">  salt                    = <span class="string">'authenticated encrypted cookie'</span></span><br><span class="line">  encrypted_cookie_cipher = <span class="string">'aes-256-gcm'</span></span><br><span class="line">  serializer              = ActiveSupport::MessageEncryptor::NullSerializer</span><br><span class="line"></span><br><span class="line">  key_generator           = ActiveSupport::KeyGenerator.new(secret_key_base, <span class="symbol">iterations:</span> <span class="number">1000</span>)</span><br><span class="line">  key_len                 = ActiveSupport::MessageEncryptor.key_len(encrypted_cookie_cipher)</span><br><span class="line">  secret                  = key_generator.generate_key(salt, key_len)</span><br><span class="line">  encryptor               = ActiveSupport::MessageEncryptor.new(secret, <span class="symbol">cipher:</span> encrypted_cookie_cipher, <span class="symbol">serializer:</span> serializer)</span><br><span class="line"></span><br><span class="line">  encryptor.decrypt_and_verify(cookie)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">cookie         = <span class="string">"QkS0eMMxz8z0Kso%3D--4opNQwT5tGUsnn90--5fXye0VQJX%2BXMVkUmK69gw%3D%3D"</span></span><br><span class="line">skb            = <span class="string">"2fc48081a207cbe98379b2ed33b5072125d6f80a55997494b021bde37cec4d9c8f17f90357d6ade926b02a3bc271ccecaf6894af1410d6ef8f6c9b3b0d871fba"</span></span><br><span class="line">cookie_session = <span class="string">"ahp9AcIyl%2BhLvQW695lhNUCnI7bF2iNZY8e4bM%2B2Lrx%2FlnbVXkYF3nL493dMM7eslFJKAyBNJKZlY5ugZpUuznCxO%2BpNXudnOdQVuDyvVBLxA8gQ4t48Gs%2BqOS7e%2FlSjBedhFKAaoBRdVI06QL8%3D--enarz3Hu%2FZ2n1Ys%2B--YdTghGWd4ZFef9Lf7WM%2FMQ%3D%3D"</span></span><br><span class="line">puts verify_and_decrypt_session_cookie(cookie_session, skb)</span><br></pre></td></tr></table></figure>

<p>Nội dung được tham khảo từ nhiều nguồn (vì không một nguồn cụ thể nào copy và chạy luôn được :unamused:), nhưng chủ yếu được tìm hiểu <a href="https://api.rubyonrails.org/classes/ActiveSupport/MessageEncryptor.html" target="_blank" rel="noopener">tại đây</a>, các bạn có thể vào trang này để tìm hiểu kỹ hơn.</p>
<p><strong>NOTE:</strong> Một điểm hết sức cần chú ý đó là biến <code>skb</code> tôi sử dụng ở trên chính là <code>secret_key_base</code> của project mà tôi sử dụng để demo, vì đây chỉ là một project test nên tôi có thể viết dạng text vào file sau đó commit lên github như này, trong tất cả các trường hợp khác thì đây là một hành động vô cùng <strong>tồi tệ</strong>, việc bị lộ <code>secret_key_base</code> sẽ khiến ứng dụng của bạn trần trụi trước hacker. Vậy nên hãy thật cẩn thận!</p>
<p>Đoạn mã trên work tốt trên rails 5.2, chú ý là cách mã hóa ở các phiên bản rails khác nhau hoàn toàn có khả năng khác nhau, nên nếu đoạn mã này không thể chạy được với rails 4 chẳng hạn thì đó là điều hết sức bình thường.</p>
<p>Trở lại vấn đề chính, nếu bạn để ý thì trong lần đầu tiên request khi bạn chưa hề làm gì và code trên server của bạn cũng chưa hề set bất kỳ giá trị cookies nào thì trong response trả về vẫn sẽ có một cookies (mà tôi đã nói ở trên, trong lần đầu request server sẽ khởi tạo và gửi về cho bạn một hoặc một vài cookies).</p>
<p>Trong trường hợp này là một, cookies đó có thể có tên dạng <code>_app_name_session</code>. Nội dung của cookies này cũng được mã hóa, thử decode bằng <code>base64</code> không được ta có thể hiểu đây là 1 cookies đã được encrypted.</p>
<p>Giá trị của cookies này trong trường hợp tôi test là:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;aW2fSskgCyZ20Fi6E68xRGl0%2FR%2FzeFWoWU5YdhgkVhB%2FMtWSsX0rf3JuRgsfPPgQXjYYNygaRSxRjXAmOcsjohN28JQJnjej0Grfpwx52cZ5qjIRdMfOS9aXdTmedpuJ7T99aObbv75D3dsPtdQ%3D--FW10HzOu9FIoKK%2B8--9sMKANggTvi%2BlBjFwpIHEg%3D%3D&quot;</span><br></pre></td></tr></table></figure>

<p>Sử dụng đoạn mã ta đã viết ở trên, ta giải mã ra được giá trị của cookies này là:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"session_id"</span><span class="symbol">:<span class="string">"52cc440e209ad03d306e550c2ca2dd78"</span></span>,</span><br><span class="line">  <span class="string">"_csrf_token"</span><span class="symbol">:<span class="string">"rD35dsIoJyf5MIRA54/ARQNMBAN0yKvfMU4RjCc9WD8="</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Vậy trong lần đầu request tới 1 website ruby on rails, nó sẽ tạo ra cho chúng ta 1 session, session lúc khởi tạo không có giá trị gì ngoài <code>session_id</code> và <code>_csrf_token</code>.</p>
<p><strong>Ủa sai sai, tôi nhớ là ngày xưa đi học được dạy rằng điểm khác biệt của session và cookies là session được lưu ở server còn cookies được lưu ở client cơ mà</strong></p>
<p>Đúng, tôi cũng được học như vậy, nhưng đó không phải là cách mà rails xử lý, <code>Rails được config mặc định là lưu session bằng cookies</code>, nếu không muốn ta có thể lưu trên <code>redis</code>, <code>database</code>… Tuy nhiên nếu không thấy ngại vì giới hạn không quá <code>4KB</code> của cookies thì tôi không thấy lý do gì để chuyển vị trí lưu trữ của session đi cả. :smiley:</p>
<p>Bây giờ tôi add thêm 1 giá trị vào session với câu lệnh <code>session[:user_id] = 1</code>, lúc này giá trị của cookies cũng thay đổi theo, lại decrypt ta thu được:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"session_id"</span><span class="symbol">:<span class="string">"52cc440e209ad03d306e550c2ca2dd78"</span></span>,</span><br><span class="line">  <span class="string">"_csrf_token"</span><span class="symbol">:<span class="string">"rD35dsIoJyf5MIRA54/ARQNMBAN0yKvfMU4RjCc9WD8="</span></span>,</span><br><span class="line">  <span class="string">"user_id"</span><span class="symbol">:</span><span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Session bây giờ đã có thêm một key mới là <code>user_id</code> với giá trị là <code>1</code>. À vậy cuối cùng thì session cũng là 1 <code>hash</code> thôi nhỉ.</p>
<h1 id="Ket-luan"><a href="#Ket-luan" class="headerlink" title="Kết luận"></a>Kết luận</h1><p>Để phân biệt các client khác nhau, server sẽ dựa vào <code>session_id</code> được lưu trong cookies, vì vậy nếu chiếm được cookies đăng nhập trên website ABC.com của bạn, các hacker có thể dùng nó để giả mạo bạn và request lên server, đáng buồn thay server sẽ đọc cookies được hacker request lên, sử dụng <code>secret_key_base</code> để giải mã cookies và đọc nội dung bên trong, đoạn code xử lý login lại đọc từ session[:user_id], lúc này thì cookies kia có giá trị <code>session[:user_id] = 1</code> và thế là server đã tưởng rằng hacker chính là bạn.</p>
<p>Trong các bài tiếp theo chúng ta sẽ tìm hiểu về một số kiểu tấn công thông thường cũng như cách phòng tránh trong rails.</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects/">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Dat-van-de"><span class="toc-number">1.</span> <span class="toc-text">Đặt vấn đề</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Luan-ban"><span class="toc-number">2.</span> <span class="toc-text">Luận bàn</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-Flow-hoat-dong"><span class="toc-number">3.</span> <span class="toc-text">1. Flow hoạt động</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Mot-vai-loai-cookies-quan-trong-trong-rails"><span class="toc-number">4.</span> <span class="toc-text">2. Một vài loại cookies quan trọng trong rails</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-Giai-ma-cookies-va-tim-hieu-ve-session-trong-rails"><span class="toc-number">5.</span> <span class="toc-text">3. Giải mã cookies và tìm hiểu về session trong rails</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ket-luan"><span class="toc-number">6.</span> <span class="toc-text">Kết luận</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&text=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&is_video=false&description=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Session Vs Cookies Trong Rails&body=Check out this article: https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&title=Session Vs Cookies Trong Rails" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=https://hdchinh.github.io/2019/04/17/2019-04-17-doi-dieu-ve-session-va-cookie-trong-rails/&name=Session Vs Cookies Trong Rails&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2019 Duy Chinh
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a href="/projects/">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">

    <!-- jquery -->
<script src="/lib/jquery/jquery.min.js"></script>
<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>
<!-- clipboard -->

  <script src="/lib/clipboard/clipboard.min.js"></script>
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight .code pre").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      target: function(trigger) {
        return trigger.nextElementSibling;
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>

<script src="/js/main.js"></script>
<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


</body>
</html>
