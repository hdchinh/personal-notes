<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>
        Notes
    </title>
    
<link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">

    
<link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">

    
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-reply replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            Vấn Đề N + 1 Và Hướng Xử Lý
        </p>
        <hr>
    </div>
    <div class="post-content">
        <h2 id="N-1-query"><a href="#N-1-query" class="headerlink" title="N+1 query"></a>N+1 query</h2><p>Xét một ví dụ:</p>
<p>Tôi có một ứng dụng đơn giản, với hai bảng csdl, bảng thứ nhất là bảng users, bảng thứ hai là bảng articles, một user có thể có nhiều articles nhưng một article chỉ thuộc về user. Hãy xem đoạn mã dưới đây:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User.all.each <span class="keyword">do</span> <span class="params">|user|</span></span><br><span class="line">  user.articles</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<p>Đoạn code trên sẽ duyệt qua tất cả user có trong csdl rồi lấy tất cả các articles ứng với từng user. Rất tường minh và dễ hiểu.</p>
<p>Tối có 5 user mẫu trong csdl nên các câu lệnh sql sinh ra sau đoạn code trên như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># câu lệnh lấy hết users lên</span></span><br><span class="line">SELECT <span class="string">"users"</span>.* FROM <span class="string">"users"</span></span><br><span class="line"><span class="comment"># ứng với mỗi user query lấy tất cả articles lên</span></span><br><span class="line">SELECT  <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> = ? LIMIT ?  [[<span class="string">"user_id"</span>, <span class="number">1</span>], [<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">SELECT  <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> = ? LIMIT ?  [[<span class="string">"user_id"</span>, <span class="number">2</span>], [<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">SELECT  <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> = ? LIMIT ?  [[<span class="string">"user_id"</span>, <span class="number">3</span>], [<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">SELECT  <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> = ? LIMIT ?  [[<span class="string">"user_id"</span>, <span class="number">4</span>], [<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">SELECT  <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> = ? LIMIT ?  [[<span class="string">"user_id"</span>, <span class="number">5</span>], [<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br></pre></td></tr></table></figure>

<p>Đây chính là ví dụ điển hình về <strong>N+1</strong>, <strong>N</strong>ở đây là 5 (số lượng user có trong csdl) và <strong>1</strong> chính là câu lệnh sql đầu tiên dùng để lấy tất cả user lên.</p>
<p>Nhìn như vô hại, mà thực ra ở ví dụ này cũng vô hại thật vì chỉ có 5 record user, nên thời gian load cũng không thấm tháp gì, tuy nhiên trong thực tế thì dữ liệu có thể rất lớn, lên đến hàng triệu record và nếu load dữ liệu như này thì đây là một vấn đề lớn cho hiệu năng của trang web. Hãy đọc tiếp mục 2 để tìm về giải pháp cho tình huống này.</p>
<h2 id="2-Giai-phap"><a href="#2-Giai-phap" class="headerlink" title="2. Giải pháp"></a>2. Giải pháp</h2><p>Vấn đề đã có, giờ chúng ta cần tìm một giải pháp làm sao để kết quả trả về không đổi, nhưng lượng truy vấn sql trong csdl phải nhỏ hơn.</p>
<p>Các phương án:</p>
<ol>
<li><p>Sử dụng <strong>select in()</strong>.</p>
</li>
<li><p>Sử dụng <strong>joins</strong>. Để đọc kỹ hơn về joins, thì nên xem ở <a href="https://www.w3schools.com/sql/sql_join.asp" target="_blank" rel="noopener">đây</a></p>
</li>
</ol>
<p>Sử dụng select in() sẽ tiết kiệm truy vấn đi rất nhiều, nếu ví dụ bên trên ta sử dụng select in() thì các sql query cần thiết sẽ là như sau:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># lấy tất cả query</span></span><br><span class="line">SELECT <span class="string">"users"</span>.* FROM <span class="string">"users"</span></span><br><span class="line"><span class="comment"># lấy articles ứng với từng user</span></span><br><span class="line">SELECT  <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> IN (<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>Tuyệt vời, từ 6(N + 1) truy vấn giờ đã trở thành còn 2.</p>
<p>Với cách thứ 2 là sử dụng <strong>joins</strong>:</p>
<p>joins hiểu đơn giản là ghép hai bảng lại với nhau (lấy một số field cần thiết ở bảng này, gộp với vài field cần thiết ở bảng kia khi mà record ở hai bên thoả mãn một điều kiện nào đó), rồi từ đó thành một bảng tạm dùng trong quá trình bạn sử dụng.</p>
<p>Quay trở về ví dụ ban đầu, câu truy vấn bây giờ sẽ trở thành:</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT User.name, Article.title</span><br><span class="line">      FROM User</span><br><span class="line">      INNER JOIN Article ON User.id = Article.user_id</span><br></pre></td></tr></table></figure>

<p>Lấy vài field cần thiết(name của user và title của Article).<br>Bằng cách thoả mãn điều kiện nào đó(id của user bằng với user_id của article).</p>
<p>Vậy từ N+1 query ban đầu, đã trở thành một query duy nhất.</p>
<p>Đến lúc này đã có thể kết luận là joins tốt hơn select in() được chưa? Chưa, câu trả lời sẽ là như vậy. Sang mục 3 chúng ta sẽ tìm hiểu về cách xử lý N+1 thông qua ActiveRecord</p>
<h2 id="3-Xu-ly-N-1-query-trong-ActiveRecord"><a href="#3-Xu-ly-N-1-query-trong-ActiveRecord" class="headerlink" title="3. Xử lý N+1 query trong ActiveRecord"></a>3. Xử lý N+1 query trong ActiveRecord</h2><p>Trong ActiveRecord cung cấp 3 phương thức để loại bỏ N+1,</p>
<ol>
<li>Sử dụng <strong>preload</strong></li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User.preload(<span class="symbol">:articles</span>)</span><br><span class="line"><span class="comment"># sql sinh ra</span></span><br><span class="line">User Load (<span class="number">0</span>.<span class="number">2</span>ms)  SELECT  <span class="string">"users"</span>.* FROM <span class="string">"users"</span> LIMIT ?  [[<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">Article Load (<span class="number">0</span>.<span class="number">4</span>ms)  SELECT <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> IN (?, ?, ?)  [[<span class="string">"user_id"</span>, <span class="number">1</span>], [<span class="string">"user_id"</span>, <span class="number">2</span>], [<span class="string">"user_id"</span>, <span class="number">3</span>]]</span><br></pre></td></tr></table></figure>
<p>Preload sẽ luôn sử dụng <strong>select in()</strong></p>
<ol start="2">
<li>Sử dụng <strong>Eagerload</strong></li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">User.eager_load(<span class="symbol">:articles</span>)</span><br><span class="line"><span class="comment"># sql sinh ra</span></span><br><span class="line">SELECT  DISTINCT <span class="string">"users"</span>.<span class="string">"id"</span> FROM <span class="string">"users"</span> LEFT OUTER JOIN <span class="string">"articles"</span> ON <span class="string">"articles"</span>.<span class="string">"user_id"</span> = <span class="string">"users"</span>.<span class="string">"id"</span> LIMIT ?  [[<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line"></span><br><span class="line">SELECT <span class="string">"users"</span>.<span class="string">"id"</span> AS t0_r<span class="number">0</span>, <span class="string">"users"</span>.<span class="string">"name"</span> AS t0_r1, <span class="string">"users"</span>.<span class="string">"created_at"</span> AS t0_r2,</span><br><span class="line"><span class="string">"users"</span>.<span class="string">"updated_at"</span> AS t0_r3, <span class="string">"articles"</span>.<span class="string">"id"</span> AS t1_r<span class="number">0</span>, <span class="string">"articles"</span>.<span class="string">"name"</span> AS t1_r1,</span><br><span class="line"><span class="string">"articles"</span>.<span class="string">"user_id"</span> AS t1_r2, <span class="string">"articles"</span>.<span class="string">"created_at"</span> AS t1_r3, <span class="string">"articles"</span>.<span class="string">"updated_at"</span> AS t1_r4</span><br><span class="line">FROM <span class="string">"users"</span> LEFT OUTER JOIN <span class="string">"articles"</span> ON <span class="string">"articles"</span>.<span class="string">"user_id"</span> = <span class="string">"users"</span>.<span class="string">"id"</span></span><br><span class="line">WHERE <span class="string">"users"</span>.<span class="string">"id"</span> IN (?, ?, ?)  [[<span class="string">"id"</span>, <span class="number">1</span>], [<span class="string">"id"</span>, <span class="number">2</span>], [<span class="string">"id"</span>, <span class="number">3</span>]]</span><br></pre></td></tr></table></figure>

<p>eager_load luôn sử dụng <strong>joins</strong></p>
<ol start="3">
<li>Sử dụng <strong>Inludes</strong></li>
</ol>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cách 1</span></span><br><span class="line">User.includes(<span class="symbol">:articles</span>)</span><br><span class="line"><span class="comment"># sql sinh ra</span></span><br><span class="line">SELECT  <span class="string">"users"</span>.* FROM <span class="string">"users"</span> LIMIT ?  [[<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">SELECT <span class="string">"articles"</span>.* FROM <span class="string">"articles"</span> WHERE <span class="string">"articles"</span>.<span class="string">"user_id"</span> IN (?, ?, ?)  [[<span class="string">"user_id"</span>, <span class="number">1</span>], [<span class="string">"user_id"</span>, <span class="number">2</span>], [<span class="string">"user_id"</span>, <span class="number">3</span>]]</span><br><span class="line"><span class="comment">#=&gt; giống preload</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># cách 2</span></span><br><span class="line">User.includes(<span class="symbol">:articles</span>).references(<span class="symbol">:articles</span>)</span><br><span class="line"><span class="comment"># sql sinh ra</span></span><br><span class="line">SELECT  DISTINCT <span class="string">"users"</span>.<span class="string">"id"</span> FROM <span class="string">"users"</span> LEFT OUTER JOIN <span class="string">"articles"</span></span><br><span class="line">ON <span class="string">"articles"</span>.<span class="string">"user_id"</span> = <span class="string">"users"</span>.<span class="string">"id"</span> LIMIT ?  [[<span class="string">"LIMIT"</span>, <span class="number">11</span>]]</span><br><span class="line">SELECT <span class="string">"users"</span>.<span class="string">"id"</span> AS t0_r<span class="number">0</span>, <span class="string">"users"</span>.<span class="string">"name"</span> AS t0_r1, <span class="string">"users"</span>.<span class="string">"created_at"</span> AS t0_r2,</span><br><span class="line"><span class="string">"users"</span>.<span class="string">"updated_at"</span> AS t0_r3, <span class="string">"articles"</span>.<span class="string">"id"</span> AS t1_r<span class="number">0</span>, <span class="string">"articles"</span>.<span class="string">"name"</span> AS t1_r1,</span><br><span class="line"><span class="string">"articles"</span>.<span class="string">"user_id"</span> AS t1_r2, <span class="string">"articles"</span>.<span class="string">"created_at"</span> AS t1_r3, <span class="string">"articles"</span>.<span class="string">"updated_at"</span> AS t1_r4</span><br><span class="line">FROM <span class="string">"users"</span> LEFT OUTER JOIN <span class="string">"articles"</span> ON <span class="string">"articles"</span>.<span class="string">"user_id"</span> = <span class="string">"users"</span>.<span class="string">"id"</span></span><br><span class="line">WHERE <span class="string">"users"</span>.<span class="string">"id"</span> IN (?, ?, ?)  [[<span class="string">"id"</span>, <span class="number">1</span>], [<span class="string">"id"</span>, <span class="number">2</span>], [<span class="string">"id"</span>, <span class="number">3</span>]]</span><br><span class="line"><span class="comment">#=&gt; giống eager_load</span></span><br></pre></td></tr></table></figure>
<p>Vậy mặc định thì <strong>includes</strong> sử dụng select in(), nhưng cũng có thể chuyển qua sử dụng joins nếu thêm method references phía sau.</p>

    </div>
    <!-- 
        <hr class="fhr">
        <div id="vcomments"></div>
     -->
</div>

    <div class="footer" id="footer">
    <p>Copyright © 2020 <a class="flink" href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>-<a class="flink" href="https://github.com/sanjinhub/hexo-theme-geek" target="_blank" rel="noopener">Geek</a>.
        <label class="el-switch el-switch-green el-switch-sm" style="vertical-align: sub;">
            <input type="checkbox" name="switch" id="update_style">
            <span class="el-switch-style"></span>
        </label>
<!--         <script type="text/javascript">
        var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
        document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
        </script> -->
    </p>
</div>
<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="CmCti21ooOOIzFOhEyFkFvR0-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="FqiyUqbg7McKN2eG0MCewupf">

<script src="/libs/jquery.min.js"></script>


<script src="/libs/highlight/highlight.pack.js"></script>

<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>

<script src="/js/js.js"></script>

<style type="text/css">
.v * {
    color: #698fca;
}

.v .vlist .vcard .vhead .vsys {
    color: #3a3e4a;
}

.v .vlist .vcard .vh .vmeta .vat {
    color: #638fd5;
}

.v .vlist .vcard .vhead .vnick {
    color: #6ba1ff;
}

.v a {
    color: #8696b1;
}

.v .vlist .vcard .vhead .vnick:hover {
    color: #669bfc;
}
</style>
</body>

</html>